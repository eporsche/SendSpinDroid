<?xml version="1.0" encoding="utf-8"?>
<!--
    AndroidManifest.xml - Application configuration and permissions
    Defines app components, permissions, and device compatibility
    Note: package attribute replaced by namespace in build.gradle.kts (AGP 7.0+)
-->
<manifest xmlns:android="http://schemas.android.com/apk/res/android">

    <!--
        PERMISSIONS:
        Permissions must be declared here and requested at runtime (for dangerous permissions).
        All permissions below are "normal" level and granted automatically at install time.
    -->

    <!-- INTERNET: Required for network communication with audio servers
         Permission level: Normal (auto-granted)
         Used by: WebSocket client, HTTP requests, audio streaming -->
    <uses-permission android:name="android.permission.INTERNET" />

    <!-- ACCESS_NETWORK_STATE: Query network connectivity status
         Permission level: Normal (auto-granted)
         Used by: Check if WiFi/cellular is available before attempting connection
         Allows: Detect network type, check if connected to internet -->
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

    <!-- ACCESS_WIFI_STATE: Query WiFi state and info
         Permission level: Normal (auto-granted)
         Used by: Get WiFi network details, check if connected to WiFi
         Note: Does not allow toggling WiFi on/off -->
    <uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />

    <!-- CHANGE_WIFI_MULTICAST_STATE: Enable multicast packet reception
         Permission level: Normal (auto-granted)
         CRITICAL FOR: mDNS/Zeroconf server discovery
         Used by: WifiManager.MulticastLock in MainActivity
         Note: Multicast is disabled by default to save battery
         Android filters multicast packets unless this lock is held -->
    <uses-permission android:name="android.permission.CHANGE_WIFI_MULTICAST_STATE" />

    <!-- FOREGROUND_SERVICE: Required for background playback service
         Permission level: Normal (auto-granted)
         Used by: Media playback service to continue playing when app is backgrounded -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE" />

    <!-- FOREGROUND_SERVICE_MEDIA_PLAYBACK: Specific foreground service type for media
         Permission level: Normal (auto-granted)
         Required on API 34+ for media playback foreground services
         Used by: MediaSessionService for background audio playback -->
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK" />

    <!-- POST_NOTIFICATIONS: Display playback notification (required on API 33+)
         Permission level: Dangerous (requires runtime permission request on API 33+)
         Used by: Display media playback controls in notification area -->
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

    <!-- WAKE_LOCK: Prevent CPU sleep during playback
         Permission level: Normal (auto-granted)
         Used by: Keep audio playback running when screen is off -->
    <uses-permission android:name="android.permission.WAKE_LOCK" />

    <!-- BIND_PLAYBACK_SERVICE: Custom permission for binding to PlaybackService
         Permission level: Signature (only apps signed with same key can use)
         Used by: This app to bind to its own PlaybackService
         Note: Required because we protect the service with this permission -->
    <uses-permission android:name="com.sendspindroid.permission.BIND_PLAYBACK_SERVICE" />

    <!--
        CUSTOM PERMISSIONS:
        Define custom permissions for protecting app components.
        Signature-level permissions ensure only apps signed with the same key can access.
    -->

    <!-- BIND_PLAYBACK_SERVICE: Protects the exported PlaybackService
         Protection level: signature - Only apps signed with the same certificate can bind
         Defense-in-depth: MediaSession already handles authentication via session tokens,
         but this adds OS-level protection against unauthorized binding attempts -->
    <permission
        android:name="com.sendspindroid.permission.BIND_PLAYBACK_SERVICE"
        android:protectionLevel="signature"
        android:label="@string/permission_bind_playback_service_label"
        android:description="@string/permission_bind_playback_service_description" />

    <!--
        Application Configuration:
        - allowBackup: Enable automatic backup to Google Drive (default: true)
        - icon: Standard launcher icon (square, all densities, supports adaptive icons on API 26+)
        - label: App name shown in launcher and settings (using string resource for localization)
        - roundIcon: Circular icon for devices that use round icons (API 25+)
        - supportsRtl: Support right-to-left languages (Arabic, Hebrew, etc.)
        - theme: Default theme for all activities (Material Components with DayNight)

        TODO for v2: Add android:fullBackupContent="@xml/backup_rules"
    -->
    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:networkSecurityConfig="@xml/network_security_config"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.SendSpinDroid">

        <!--
            Android Auto Support
            Declares this app as a media app that can be used with Android Auto.
            Android Auto will automatically discover and display this app.
        -->
        <meta-data
            android:name="com.google.android.gms.car.application"
            android:resource="@xml/automotive_app_desc"/>

        <!--
            TODO for v2: Add application-level configurations:
            - android:name=".MyApplication" (custom Application class)
            - android:usesCleartextTraffic="false" (enforce HTTPS, currently needed for local servers)
            - android:networkSecurityConfig (custom network security rules)
        -->

        <!-- MainActivity: Primary activity and app entry point
             - exported: Allow external apps to launch (required for MAIN/LAUNCHER intent-filter)
             - Security: Only export activities that should be accessible externally -->
        <activity
            android:name=".MainActivity"
            android:exported="true">

            <!-- intent-filter: Defines how this activity can be started
                 This combination makes MainActivity the app's launcher icon -->
            <intent-filter>
                <!-- MAIN: This is a main entry point (no data needed to launch) -->
                <action android:name="android.intent.action.MAIN" />

                <!-- LAUNCHER: Show this activity in the app launcher -->
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>

            <!--
                TODO for v2: Consider activity-level configurations:
                - android:screenOrientation="portrait" (lock orientation)
                - android:configChanges (handle config changes manually)
                - android:launchMode (control task/back stack behavior)
                - android:windowSoftInputMode (keyboard behavior)
            -->
        </activity>

        <!-- SettingsActivity: User preferences screen
             - parentActivityName: Enable up navigation to MainActivity -->
        <activity
            android:name=".SettingsActivity"
            android:exported="false"
            android:parentActivityName=".MainActivity">
            <meta-data
                android:name="android.support.PARENT_ACTIVITY"
                android:value=".MainActivity" />
        </activity>

        <!--
            PlaybackService: Background audio playback service with Android Auto support
            - foregroundServiceType: Required on API 29+ to specify service purpose
            - exported: Allow MediaController connections from other apps/system (required for MediaBrowserService)
            - permission: Signature-level protection ensures only apps signed with same key can bind
              This is defense-in-depth; MediaSession handles auth via tokens, but this adds OS-level security
            - intent-filter: Declares this as a MediaLibraryService for system integration
              and Android Auto browse tree support
        -->
        <service
            android:name=".playback.PlaybackService"
            android:foregroundServiceType="mediaPlayback"
            android:exported="true"
            android:permission="com.sendspindroid.permission.BIND_PLAYBACK_SERVICE">
            <intent-filter>
                <!-- MediaLibraryService action for Media3 integration (Android Auto browse tree) -->
                <action android:name="androidx.media3.session.MediaLibraryService" />
                <!-- Backward compatibility with older MediaBrowserService clients -->
                <action android:name="android.media.browse.MediaBrowserService" />
            </intent-filter>
        </service>

        <!--
            MediaButtonReceiver: Handles media button events (headset, Bluetooth)
            - Forwards media button intents to the MediaSessionService
            - Required for proper media button handling on all Android versions
        -->
        <receiver
            android:name="androidx.media3.session.MediaButtonReceiver"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MEDIA_BUTTON" />
            </intent-filter>
        </receiver>

        <!--
            FileProvider: Secure file sharing for debug logs
            - Allows sharing log files via Android's share intent
            - Only exposes debug_logs subdirectory in cache
        -->
        <provider
            android:name="androidx.core.content.FileProvider"
            android:authorities="${applicationId}.fileprovider"
            android:exported="false"
            android:grantUriPermissions="true">
            <meta-data
                android:name="android.support.FILE_PROVIDER_PATHS"
                android:resource="@xml/file_paths" />
        </provider>
    </application>

    <!--
        TODO for v2: Add feature declarations for Google Play filtering:
        <uses-feature android:name="android.hardware.wifi" android:required="true" />
        <uses-feature android:name="android.hardware.audio.output" android:required="true" />
        <uses-feature android:name="android.software.leanback" android:required="false" /> (for Android TV)
    -->

</manifest>
